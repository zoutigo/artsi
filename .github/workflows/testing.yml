name: phpunit
on: [push]

jobs:

  tests :
    name: Running functional and unit test
    runs-on: ubuntu-20.04
    services:
      mysql:
        image: mysql:5.7
        env:
          MYSQL_ROOT_PASSWORD: pass_test
          MYSQL_DATABASE: myapptest
          MYSQL_USER: myapptest
          MYSQL_PASSWORD: myapptest
          DATABASE_URL: 'mysql://myapptest:myapptest@mysql:3306/myapptest'
        ports:
          - 3306:3306
    strategy:
      fail-fast: true
      matrix:
        php-versions: ['7.4-apache']

    steps:
          # https://github.com/shivammathur/setup-php (community)
        - name: Setup PHP, extensions and composer with shivammathur/setup-php
          uses: shivammathur/setup-php@v2
          with:
            php-version: ${{ matrix.php-versions }}
            extensions: mbstring, xml, ctype, iconv, intl, pdo, pdo_mysql, dom, filter, gd, iconv, json, mbstring,mysqli
          env:
            update: true

        - name: Check PHP Version
          run: php -v
        - run: curl sSk https://getcomposer.org/installer | php -- --disable-tls && mv composer.phar /usr/local/bin/composer
        - run : sudo rm -rf /var/lib/apt/lists/lock
        - run: sudo apt -yqq update
        - run: sudo apt-get install -y mysqli zip        
        - run: php bin/console doctrine:database:drop --force --env=test
        - run: php bin/console doctrine:database:create --env=test
        - run: php bin/console doctrine:migrations:migrate --env=test --no-interaction
        - run: php bin/console doctrine:fixtures:load --no-interaction
        
          # â€”â€” Composer ğŸ§™â€ï¸ â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
        - name: Validate composer.json and composer.lock
          run: composer validate

        - name: Get composer cache directory
          id: composer-cache
          run: echo "::set-output name=dir::$(composer config cache-files-dir)"

        - name: Cache composer dependencies
          uses: actions/cache@v1
          with:
            path: ${{ steps.composer-cache.outputs.dir }}
            key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
            restore-keys: ${{ runner.os }}-composer-

        - name: Install Composer dependencies
          run: composer install

         ## â€”â€” NPM ğŸ± â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
        - name: npm install
          uses: actions/setup-node@v2
          with:
            node-version: '14'
            #registry-url: npm.fontawesome.com
        - run: npm install
            #env:
          #NODE_AUTH_TOKEN: ${{ secrets.FONTAWESOME_NPM_AUTH_TOKEN }}


        - run: npm run build
        - run: php bin/phpunit